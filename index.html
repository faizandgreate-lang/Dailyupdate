<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Live Google Sheet - Update</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial; margin: 10px; background: #f8f9fa; }
  h2 { text-align: center; color: #333; }
  input, select { display: block; margin: 10px auto; padding: 10px; width: 90%; max-width: 350px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
  .table-container { max-height: 500px; overflow-y: auto; overflow-x: auto; border: 1px solid #ddd; background: white; }
  table { width: 100%; border-collapse: collapse; min-width: 1200px; }
  th, td { padding: 8px; border: 1px solid #ddd; text-align: left; white-space: pre-line; }
  th { background: #f0f0f0; position: sticky; top: 0; cursor: pointer; z-index: 1; }
  th.sorted-asc::after { content: " ▲"; }
  th.sorted-desc::after { content: " ▼"; }
  tr:hover { background-color: #f1f1f1; }
  .highlight { background-color: yellow; }
  @media screen and (max-width: 600px) {
    table { font-size: 12px; min-width: 800px; }
    input, select { font-size: 14px; padding: 8px; width: 95%; }
  }
</style>
</head>
<body>

<h2>Live Sheet: Update</h2>

<input type="text" id="searchInput" placeholder="Search..." onkeyup="updateTable()">
<select id="filterDropdown" onchange="updateTable()">
  <option value="">All Clients</option>
</select>

<div class="table-container">
  <table id="dataTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
google.charts.load('current', {'packages':['table']});
google.charts.setOnLoadCallback(drawTable);

const SHEET_ID = '1naM9QUQa0PpDWITE7lYPCazNwdpLBpGLQCHsYWmG-nY';
const SHEET_NAME = 'Update';
let allData = [];
let sortColumn = null;
let sortAsc = true;

// Load live Google Sheet data
function drawTable() {
  const query = new google.visualization.Query(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&headers=1`);
  query.send(handleQueryResponse);
}

function handleQueryResponse(response) {
  if (response.isError()) {
    alert('Error loading data: ' + response.getMessage());
    return;
  }

  const data = response.getDataTable();
  allData = [];

  // Convert to simple array for easier search/filter
  for (let i = 0; i < data.getNumberOfRows(); i++) {
    const row = [];
    for (let j = 0; j < data.getNumberOfColumns(); j++) {
      row.push(data.getValue(i,j));
    }
    allData.push(row);
  }

  // Populate dropdown (example: column index 10 = "Client")
  const dropdown = document.getElementById('filterDropdown');
  const uniqueValues = [...new Set(allData.map(r => r[10]))].filter(v => v);
  uniqueValues.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    dropdown.appendChild(opt);
  });

  // Render table
  updateTable();
}

// Render table with search & filter
function updateTable() {
  const searchVal = document.getElementById('searchInput').value.toLowerCase();
  const filterVal = document.getElementById('filterDropdown').value;

  let filtered = [...allData];

  if (filterVal) filtered = filtered.filter(r => r[10] === filterVal);
  if (searchVal) filtered = filtered.filter(r => r.join(' ').toLowerCase().includes(searchVal));

  // Sort if applicable
  if (sortColumn !== null) {
    filtered.sort((a, b) => {
      const valA = a[sortColumn] || '';
      const valB = b[sortColumn] || '';
      if (!isNaN(valA) && !isNaN(valB)) return sortAsc ? valA - valB : valB - valA;
      return sortAsc ? valA.toString().localeCompare(valB.toString()) : valB.toString().localeCompare(valA.toString());
    });
  }

  renderTable(filtered, searchVal);
}

// Render table with highlighted search matches
function renderTable(rows, highlightText='') {
  const table = document.getElementById('dataTable');
  table.innerHTML = '';

  // Create header row
  const headerRow = document.createElement('tr');
  allData[0].forEach((h, idx) => {
    const th = document.createElement('th');
    th.innerText = h;
    th.onclick = () => sortColumnClick(idx);
    if (idx === sortColumn) th.className = sortAsc ? 'sorted-asc' : 'sorted-desc';
    headerRow.appendChild(th);
  });
  table.appendChild(headerRow);

  // Data rows
  rows.forEach(r => {
    const tr = document.createElement('tr');
    r.forEach(c => {
      const td = document.createElement('td');
      if (highlightText && c && c.toString().toLowerCase().includes(highlightText)) {
        const regex = new RegExp(`(${highlightText})`, 'gi');
        td.innerHTML = c.toString().replace(regex, '<span class="highlight">$1</span>');
      } else {
        td.innerText = c;
      }
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

// Sorting on column click
function sortColumnClick(idx) {
  if (sortColumn === idx) sortAsc = !sortAsc;
  else { sortColumn = idx; sortAsc = true; }
  updateTable();
}
</script>

</body>
</html>

